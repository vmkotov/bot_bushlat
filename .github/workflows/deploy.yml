name: üöÄ Deploy Bushlatinga Bot to Yandex Cloud

on:
  push:
    branches: [ main, master ]
    paths:
      - '**.go'
      - 'go.mod'
      - 'go.sum'
      - 'Dockerfile.yc'
      - 'deploy-yc.sh'
      - '.github/workflows/deploy.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    # –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
    - name: üì• Checkout code
      uses: actions/checkout@v3
      
    # –®–ê–ì 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Go
    - name: üîß Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    # –®–ê–ì 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Go
    - name: üì¶ Install Go dependencies
      run: |
        echo "üîß –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Go..."
        go mod download
        go mod verify
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
      
    # –®–ê–ì 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Yandex Cloud CLI
    - name: üîê Setup Yandex Cloud CLI
      run: |
        echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Yandex Cloud CLI..."
        curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash -s -- -i /usr/local -n
        echo "/usr/local/bin" >> $GITHUB_PATH
        yc version
        echo "‚úÖ Yandex Cloud CLI —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
      
    # –®–ê–ì 5: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Yandex Cloud
    - name: ‚öôÔ∏è Configure Yandex Cloud
      run: |
        echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Yandex Cloud..."
        yc config set token ${{ secrets.YC_OAUTH_TOKEN }}
        yc config set cloud-id ${{ secrets.YC_CLOUD_ID }}
        yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
        echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
        
    # –®–ê–ì 6: –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Container Registry
    - name: üê≥ Login to Yandex Container Registry
      run: |
        echo "üîê –õ–æ–≥–∏–Ω–∏–º—Å—è –≤ Container Registry..."
        echo ${{ secrets.YC_IAM_TOKEN }} | docker login \
          --username iam \
          --password-stdin \
          cr.yandex
        echo "‚úÖ –£—Å–ø–µ—à–Ω—ã–π –ª–æ–≥–∏–Ω –≤ Container Registry"
          
    # –®–ê–ì 7: –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
    - name: üèóÔ∏è Build Docker image
      run: |
        echo "üê≥ –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑..."
        docker build \
          -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/bushlatinga-bot:latest \
          -t cr.yandex/${{ secrets.YC_REGISTRY_ID }}/bushlatinga-bot:${{ github.sha }} \
          -f Dockerfile.yc .
        echo "‚úÖ Docker –æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–Ω"
          
    # –®–ê–ì 8: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑ –≤ —Ä–µ–µ—Å—Ç—Ä
    - name: üì¶ Push Docker image
      run: |
        echo "üì§ –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—Ä–∞–∑ –≤ Container Registry..."
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/bushlatinga-bot:latest
        docker push cr.yandex/${{ secrets.YC_REGISTRY_ID }}/bushlatinga-bot:${{ github.sha }}
        echo "‚úÖ –û–±—Ä–∞–∑ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ Container Registry"
        
    # –®–ê–ì 9: –î–µ–ø–ª–æ–∏–º –≤ Yandex Serverless Container
    - name: üöÄ Deploy to Yandex Serverless Container
      run: |
        echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –≤ Yandex Cloud..."
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        ENV_VARS="TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }},\
ADMIN_CHAT_ID=${{ secrets.ADMIN_CHAT_ID }},\
DEBUG=${{ secrets.DEBUG }},\
LOG_LEVEL=${{ secrets.LOG_LEVEL }}"
        
        # –î–æ–±–∞–≤–ª—è–µ–º DATABASE_URL –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
        if [ -n "${{ secrets.DATABASE_URL }}" ]; then
          ENV_VARS="$ENV_VARS,DATABASE_URL=${{ secrets.DATABASE_URL }}"
          echo "üìä DATABASE_URL –¥–æ–±–∞–≤–ª–µ–Ω"
        else
          echo "‚ÑπÔ∏è DATABASE_URL –Ω–µ —É–∫–∞–∑–∞–Ω, –±–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ memory-only —Ä–µ–∂–∏–º–µ"
        fi
        
        echo "üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        echo "$ENV_VARS" | tr ',' '\n'
        
        # –î–µ–ø–ª–æ–∏–º –Ω–æ–≤—É—é —Ä–µ–≤–∏–∑–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
        echo "‚ö° –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Ä–µ–≤–∏–∑–∏—é –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
        yc serverless container revision deploy \
          --container-name bushlatinga-bot \
          --image cr.yandex/${{ secrets.YC_REGISTRY_ID }}/bushlatinga-bot:${{ github.sha }} \
          --cores 1 \
          --memory 128MB \
          --concurrency 1 \
          --execution-timeout 300s \
          --service-account-id ${{ secrets.YC_SERVICE_ACCOUNT_ID }} \
          --environment "$ENV_VARS" \
          --description "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –∏–∑ GitHub: ${{ github.sha }}"
          
        echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
          
    # –®–ê–ì 10: –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–µ–ø–ª–æ—è
    - name: üìä Verify deployment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–µ–ø–ª–æ—è..."
        echo "üìã –ü–æ—Å–ª–µ–¥–Ω—è—è —Ä–µ–≤–∏–∑–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞:"
        yc serverless container revision list \
          --container-name bushlatinga-bot \
          --limit 1 \
          --format json | jq -r '.[0] | "–°—Ç–∞—Ç—É—Å: \(.status)\n–û–ø–∏—Å–∞–Ω–∏–µ: \(.description)\n–í—Ä–µ–º—è —Å–æ–∑–¥–∞–Ω–∏—è: \(.created_at)"'
        
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω! –ë–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω."

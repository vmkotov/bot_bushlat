package main

import (
	"log"
	"net/http"
	"os"
	"strconv"
	"time"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
	"github.com/joho/godotenv"
	"github.com/vmkotov/telelog"

	"bushlatinga_bot/bot"
	"bushlatinga_bot/database"
)

func main() {
	//======================================================
	// –ë–õ–û–ö 1: –ù–ê–ß–ê–õ–û –†–ê–ë–û–¢–´ –ò –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
	//======================================================
	log.Println("üîß –ó–∞–ø—É—Å–∫–∞—é Bushlatinga Bot v3.0 (–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)...")

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
	if err := godotenv.Load(); err != nil {
		log.Printf("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω: %v", err)
	}

	//======================================================
	// –ë–õ–û–ö 2: –ù–ê–°–¢–†–û–ô–ö–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê
	//======================================================

	// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
	token := os.Getenv("TELEGRAM_BOT_TOKEN")
	if token == "" {
		log.Fatal("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")
	}

	// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ Telegram API
	botAPI, err := tgbotapi.NewBotAPI(token)
	if err != nil {
		log.Fatalf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞: %v", err)
	}

	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
	botAPI.Debug = os.Getenv("DEBUG") == "true"
	log.Printf("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ @%s (ID: %d)", botAPI.Self.UserName, botAPI.Self.ID)

	//======================================================
	// –ë–õ–û–ö 3: –•–ê–†–î–ö–û–î –ù–ê–°–¢–†–û–ï–ö –î–õ–Ø –ü–ï–†–ï–°–´–õ–ö–ò –°–û–û–ë–©–ï–ù–ò–ô
	//======================================================

	// –•–ê–†–î–ö–û–î: ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π (–ß–∞—Ç B: –ê—Ä—Ö–∏–≤)
	forwardChatID := int64(-1003669576601)
	log.Printf("üéØ –•–∞—Ä–¥–∫–æ–¥ ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ (–ß–∞—Ç B): %d", forwardChatID)

	//======================================================
	// –ë–õ–û–ö 4: –•–ê–†–î–ö–û–î –î–õ–Ø TELELOGGER (–ß–∞—Ç A: –í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
	//======================================================

	// –•–ê–†–î–ö–û–î: ID —á–∞—Ç–∞ –¥–ª—è TeleLogger (–ß–∞—Ç A: –í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
	teleLoggerChatID := int64(-1003459160643)
	log.Printf("üéØ –•–∞—Ä–¥–∫–æ–¥ ID —á–∞—Ç–∞ –¥–ª—è TeleLogger (–ß–∞—Ç A): %d", teleLoggerChatID)

	//======================================================
	// –ë–õ–û–ö 5: –•–ê–†–î–ö–û–î –î–õ–Ø –î–ï–ü–õ–û–ô –£–í–ï–î–û–ú–õ–ï–ù–ò–ô (–ß–∞—Ç D: –î–µ–ø–ª–æ–π)
	//======================================================

	// –•–ê–†–î–ö–û–î: ID —á–∞—Ç–∞ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –¥–µ–ø–ª–æ–µ (–ß–∞—Ç D: –î–µ–ø–ª–æ–π)
	deployChatID := int64(-1003685049289)
	log.Printf("üéØ –•–∞—Ä–¥–∫–æ–¥ ID —á–∞—Ç–∞ –¥–ª—è –¥–µ–ø–ª–æ–π-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–ß–∞—Ç D): %d", deployChatID)

	//======================================================
	// –ë–õ–û–ö 6: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELELOGGER –° –•–ê–†–î–ö–û–î–û–ú
	//======================================================

	var teleLogger telelog.TeleLogger

	// TeleLogger –∏–¥–µ—Ç –≤ –ß–∞—Ç A (-1003459160643)
	if teleLoggerChatID != 0 {
		teleLogger = telelog.New(telelog.Options{
			Bot:         botAPI,
			LogChatID:   teleLoggerChatID,
			BotID:       botAPI.Self.ID,
			BotUsername: botAPI.Self.UserName,
		})
		log.Printf("‚úÖ TeleLogger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ß–∞—Ç –ê (ID: %d)", teleLoggerChatID)

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —á–∞—Ç–∞
		if teleLogger.IsEnabled() {
			testMsg := tgbotapi.NewMessage(teleLoggerChatID,
				"üîÑ *Bushlatinga Bot –∑–∞–ø—É—â–µ–Ω!*\n\n"+
					"üìä *–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤:*\n"+
					"‚Ä¢ –≠—Ç–æ—Ç —á–∞—Ç: –í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (TeleLogger)\n"+
					"‚Ä¢ –ß–∞—Ç B (-1003669576601): –ê—Ä—Ö–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π\n"+
					"‚Ä¢ –ß–∞—Ç C (-1003585352063): –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏\n"+
					"‚Ä¢ –ß–∞—Ç D (-1003685049289): –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ")
			testMsg.ParseMode = "Markdown"

			if _, err := botAPI.Send(testMsg); err != nil {
				log.Printf("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç –≤ –ß–∞—Ç –ê %d: %v", teleLoggerChatID, err)
			} else {
				log.Printf("‚úÖ –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ß–∞—Ç –ê")
			}
		}
	} else {
		teleLogger = telelog.SimpleNew()
		log.Println("‚ö†Ô∏è ID —á–∞—Ç–∞ –¥–ª—è TeleLogger —Ä–∞–≤–µ–Ω 0, –∏—Å–ø–æ–ª—å–∑—É—é –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä")
	}

	//======================================================
	// –ë–õ–û–ö 7: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
	//======================================================

	var dbHandler *database.BotDatabaseHandler
	dbURL := os.Getenv("DATABASE_URL")

	if dbURL != "" {
		adminID := int64(266468924)

		if adminEnv := os.Getenv("ADMIN_CHAT_ID"); adminEnv != "" {
			if id, err := strconv.ParseInt(adminEnv, 10, 64); err == nil {
				adminID = id
				log.Printf("üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–∑ .env: %d", adminID)
			}
		}

		var err error
		dbHandler, err = database.NewBotDatabaseHandler(adminID, dbURL)
		if err != nil {
			log.Printf("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ë–î: %v", err)
			log.Printf("‚ö†Ô∏è –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
		} else {
			defer dbHandler.Close()
			log.Printf("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
		}
	} else {
		log.Println("‚ÑπÔ∏è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
	}

	//======================================================
	// –ë–õ–û–ö 8: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–°–´–õ–ö–ò –°–û–û–ë–©–ï–ù–ò–ô (MESSAGE FORWARDER)
	//======================================================

	var messageForwarder *bot.MessageForwarder

	if forwardChatID != 0 {
		messageForwarder = bot.NewMessageForwarder(botAPI, forwardChatID)
		log.Printf("‚úÖ MessageForwarder –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
		log.Printf("   üéØ –ß–∞—Ç B (–ê—Ä—Ö–∏–≤): %d", forwardChatID)
	} else {
		log.Println("‚ö†Ô∏è ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Ä–∞–≤–µ–Ω 0, MessageForwarder –Ω–µ —Å–æ–∑–¥–∞–Ω")
	}

	//======================================================
	// –ë–õ–û–ö 9: –°–û–ó–î–ê–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê –¢–ï–õ–ï–ì–†–ê–ú –í–ï–ë–•–£–ö–û–í
	//======================================================

	telegramHandler := bot.NewTelegramHandler(
		botAPI,
		dbHandler,
		teleLogger,
		messageForwarder,
	)

	log.Println("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Telegram –≤–µ–±—Ö—É–∫–æ–≤ —Å–æ–∑–¥–∞–Ω")

	//======================================================
	// –ë–õ–û–ö 10: –ù–ê–°–¢–†–û–ô–ö–ê HTTP –°–ï–†–í–ï–†–ê –ò –†–û–£–¢–ò–ù–ì–ê
	//======================================================

	http.HandleFunc("/", telegramHandler.HandleWebhook)

	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
		log.Printf("‚ö†Ô∏è PORT –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: %s", port)
	}

	//======================================================
	// –ë–õ–û–ö 11: –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –î–ï–ü–õ–û–ï –í –û–¢–î–ï–õ–¨–ù–´–ô –ß–ê–¢
	//======================================================

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —á–∞—Ç D
	if deployChatID != 0 && botAPI != nil {
		deployText := "üöÄ *–£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –î–ï–ü–õ–û–ï*\n\n" +
			"üì¶ *–í–µ—Ä—Å–∏—è:* 3.0.0\n" +
			"üîß *–û–∫—Ä—É–∂–µ–Ω–∏–µ:* " + getEnvOrDefault("ENVIRONMENT", "production") + "\n" +
			"üåø *–í–µ—Ç–∫–∞:* " + getEnvOrDefault("BRANCH", "main") + "\n" +
			"üìù *–ö–æ–º–º–∏—Ç:* " + getEnvOrDefault("COMMIT_HASH", "unknown") + "\n" +
			"üë§ *–î–µ–ø–ª–æ–π–µ—Ä:* Bushlatinga Bot\n" +
			"‚è∞ *–í—Ä–µ–º—è:* " + time.Now().Format("2006-01-02 15:04:05") + "\n" +
			"ü§ñ *–ë–æ—Ç:* @" + botAPI.Self.UserName + "\n\n" +
			"üìä *–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤:*\n" +
			"‚Ä¢ –ß–∞—Ç –ê: –í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
			"‚Ä¢ –ß–∞—Ç B: –ê—Ä—Ö–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π\n" +
			"‚Ä¢ –ß–∞—Ç C: –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏\n" +
			"‚Ä¢ –ß–∞—Ç D: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ\n\n" +
			"‚úÖ *–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!*"

		deployMsg := tgbotapi.NewMessage(deployChatID, deployText)
		deployMsg.ParseMode = "Markdown"

		if _, err := botAPI.Send(deployMsg); err != nil {
			log.Printf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ –≤ —á–∞—Ç %d: %v", deployChatID, err)
		} else {
			log.Printf("‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ß–∞—Ç D (%d)", deployChatID)
		}
	}

	//======================================================
	// –ë–õ–û–ö 12: –ó–ê–ü–£–°–ö HTTP –°–ï–†–í–ï–†–ê
	//======================================================

	log.Printf("üåê –ó–∞–ø—É—Å–∫–∞—é HTTP —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É %s", port)
	log.Println("======================================================")
	log.Println("ü§ñ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ! (–ü—Ä–æ–¥–∞–∫—à–µ–Ω –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)")
	log.Println("üìä –†–ê–°–ü–†–ï–î–ï–õ–ï–ù–ò–ï –õ–û–ì–û–í:")
	log.Println("   üìç –ß–∞—Ç –ê (TeleLogger):", teleLoggerChatID, "- –í–∞–∂–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è")
	log.Println("   üìç –ß–∞—Ç B (Forwarder):", forwardChatID, "- –ê—Ä—Ö–∏–≤ —Å–æ–æ–±—â–µ–Ω–∏–π")
	log.Println("   üìç –ß–∞—Ç C (DBLogger): -1003585352063 - –î–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏")
	log.Println("   üìç –ß–∞—Ç D (Deploy):", deployChatID, "- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–µ–ø–ª–æ–µ")
	log.Println("======================================================")

	if err := http.ListenAndServe(":"+port, nil); err != nil {
		log.Fatalf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: %v", err)
	}
}

//======================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
//======================================================

func getEnvOrDefault(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}

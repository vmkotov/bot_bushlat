package main

import (
	"log"
	"net/http"
	"os"
	"strconv"
	"time"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
	"github.com/joho/godotenv"
	"github.com/vmkotov/telelog"

	"bushlatinga_bot/bot"
	"bushlatinga_bot/database"
)

func main() {
	//======================================================
	// –ë–õ–û–ö 1: –ù–ê–ß–ê–õ–û –†–ê–ë–û–¢–´ –ò –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò
	//======================================================
	log.Println("üîß –ó–∞–ø—É—Å–∫–∞—é Bushlatinga Bot v3.0 (–ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)...")

	// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
	if err := godotenv.Load(); err != nil {
		log.Printf("‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω: %v", err)
	}

	//======================================================
	// –ë–õ–û–ö 2: –ù–ê–°–¢–†–û–ô–ö–ê –ò –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –¢–ï–õ–ï–ì–†–ê–ú –ë–û–¢–ê
	//======================================================

	// –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
	token := os.Getenv("TELEGRAM_BOT_TOKEN")
	if token == "" {
		log.Fatal("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env")
	}

	// –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ Telegram API
	botAPI, err := tgbotapi.NewBotAPI(token)
	if err != nil {
		log.Fatalf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞: %v", err)
	}

	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏
	botAPI.Debug = os.Getenv("DEBUG") == "true"
	log.Printf("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ @%s (ID: %d)", botAPI.Self.UserName, botAPI.Self.ID)

	//======================================================
	// –ë–õ–û–ö 3: –•–ê–†–î–ö–û–î –ù–ê–°–¢–†–û–ï–ö –î–õ–Ø –ü–ï–†–ï–°–´–õ–ö–ò –°–û–û–ë–©–ï–ù–ò–ô
	//======================================================

	// –•–ê–†–î–ö–û–î: ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
	// ‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ó–∞–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç ID –Ω–∞ ID –≤–∞—à–µ–≥–æ —Ü–µ–ª–µ–≤–æ–≥–æ —á–∞—Ç–∞!
	forwardChatID := int64(-1003669576601)
	log.Printf("üéØ –•–∞—Ä–¥–∫–æ–¥ ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏: %d", forwardChatID)

	//======================================================
	// –ë–õ–û–ö 4: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELELOGGER (–õ–û–ì–ò–†–û–í–ê–ù–ò–ï –í –¢–ï–õ–ï–ì–†–ê–ú)
	//======================================================

	var teleLogger telelog.TeleLogger
	var logChatID int64

	// –ü–æ–ª—É—á–∞–µ–º ID —á–∞—Ç–∞ –¥–ª—è –ª–æ–≥–æ–≤ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
	logChatIDStr := os.Getenv("LOG_CHAT_ID")

	// –ï—Å–ª–∏ LOG_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —á–∞—Ç, —á—Ç–æ –∏ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏
	if logChatIDStr == "" {
		logChatIDStr = strconv.FormatInt(forwardChatID, 10) // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–π ID
		log.Printf("‚ö†Ô∏è LOG_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–π ID: %s", logChatIDStr)
	}

	if logChatIDStr != "" {
		var err error
		logChatID, err = strconv.ParseInt(logChatIDStr, 10, 64)
		if err == nil && logChatID != 0 {
			// –°–æ–∑–¥–∞–µ–º –ª–æ–≥–≥–µ—Ä —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
			teleLogger = telelog.New(telelog.Options{
				Bot:         botAPI,
				LogChatID:   logChatID,
				BotID:       botAPI.Self.ID,
				BotUsername: botAPI.Self.UserName,
			})
			log.Printf("‚úÖ TeleLogger –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è —á–∞—Ç–∞ ID: %d", logChatID)
		} else {
			// –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä
			teleLogger = telelog.SimpleNew()
			log.Printf("‚ö†Ô∏è –ù–µ–≤–µ—Ä–Ω—ã–π LOG_CHAT_ID, –∏—Å–ø–æ–ª—å–∑—É—é –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä")
		}
	} else {
		teleLogger = telelog.SimpleNew()
		log.Println("‚ÑπÔ∏è LOG_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –∫–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥–≥–µ—Ä")
	}

	//======================================================
	// –ë–õ–û–ö 5: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
	//======================================================

	var dbHandler *database.BotDatabaseHandler
	dbURL := os.Getenv("DATABASE_URL")

	if dbURL != "" {
		// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
		adminID := int64(266468924)

		// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
		if adminEnv := os.Getenv("ADMIN_CHAT_ID"); adminEnv != "" {
			if id, err := strconv.ParseInt(adminEnv, 10, 64); err == nil {
				adminID = id
				log.Printf("üëë –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–∑ .env: %d", adminID)
			}
		}

		// –°–æ–∑–¥–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
		var err error
		dbHandler, err = database.NewBotDatabaseHandler(adminID, dbURL)
		if err != nil {
			log.Printf("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –ë–î: %v", err)
			log.Printf("‚ö†Ô∏è –ë–æ—Ç –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
		} else {
			defer dbHandler.Close() // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
			log.Printf("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ë–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
		}
	} else {
		log.Println("‚ÑπÔ∏è DATABASE_URL –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –±–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö")
	}

	//======================================================
	// –ë–õ–û–ö 6: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–ï–†–ï–°–´–õ–ö–ò –°–û–û–ë–©–ï–ù–ò–ô (MESSAGE FORWARDER)
	//======================================================

	var messageForwarder *bot.MessageForwarder

	// –°–æ–∑–¥–∞–µ–º –ø–µ—Ä–µ—Å—ã–ª—å—â–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π —Å —Ö–∞—Ä–¥–∫–æ–¥–Ω—ã–º ID —á–∞—Ç–∞
	if forwardChatID != 0 {
		messageForwarder = bot.NewMessageForwarder(botAPI, forwardChatID)
		log.Printf("‚úÖ MessageForwarder –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
		log.Printf("   üéØ –¶–µ–ª–µ–≤–æ–π —á–∞—Ç ID: %d", forwardChatID)
		log.Printf("   üì® –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å—Å—è –≤ —ç—Ç–æ—Ç —á–∞—Ç")
	} else {
		log.Println("‚ö†Ô∏è ID —á–∞—Ç–∞ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏ —Ä–∞–≤–µ–Ω 0, MessageForwarder –Ω–µ —Å–æ–∑–¥–∞–Ω")
	}

	//======================================================
	// –ë–õ–û–ö 7: –°–û–ó–î–ê–ù–ò–ï –û–ë–†–ê–ë–û–¢–ß–ò–ö–ê –¢–ï–õ–ï–ì–†–ê–ú –í–ï–ë–•–£–ö–û–í
	//======================================================

	// –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
	telegramHandler := bot.NewTelegramHandler(
		botAPI,           // Telegram –±–æ—Ç
		dbHandler,        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ë–î (–º–æ–∂–µ—Ç –±—ã—Ç—å nil)
		teleLogger,       // –õ–æ–≥–≥–µ—Ä
		messageForwarder, // –ü–µ—Ä–µ—Å—ã–ª—å—â–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
	)

	log.Println("‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Telegram –≤–µ–±—Ö—É–∫–æ–≤ —Å–æ–∑–¥–∞–Ω")

	//======================================================
	// –ë–õ–û–ö 8: –ù–ê–°–¢–†–û–ô–ö–ê HTTP –°–ï–†–í–ï–†–ê –ò –†–û–£–¢–ò–ù–ì–ê
	//======================================================

	// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–µ–±—Ö—É–∫–æ–≤
	http.HandleFunc("/", telegramHandler.HandleWebhook)

	// –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
	port := os.Getenv("PORT")
	if port == "" {
		port = "8080"
		log.Printf("‚ö†Ô∏è PORT –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É—é –ø–æ—Ä—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: %s", port)
	}

	//======================================================
	// –ë–õ–û–ö 9: –û–¢–ü–†–ê–í–ö–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –û –ó–ê–ü–£–°–ö–ï
	//======================================================

	// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞
	if teleLogger != nil && teleLogger.IsEnabled() {
		deployInfo := map[string]string{
			"version":      "3.0.0",
			"environment":  getEnvOrDefault("ENVIRONMENT", "production"),
			"branch":       getEnvOrDefault("BRANCH", "main"),
			"commit_hash":  getEnvOrDefault("COMMIT_HASH", "unknown"),
			"deployer":     "Bushlatinga Bot",
			"timestamp":    time.Now().Format("2006-01-02 15:04:05"),
			"forward_chat": strconv.FormatInt(forwardChatID, 10),
		}

		teleLogger.SendDeployNotification(deployInfo)
		log.Println("üöÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
	} else {
		log.Println("‚ö†Ô∏è TeleLogger –Ω–µ –≤–∫–ª—é—á–µ–Ω, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–µ–ø–ª–æ–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
	}

	//======================================================
	// –ë–õ–û–ö 10: –ó–ê–ü–£–°–ö HTTP –°–ï–†–í–ï–†–ê
	//======================================================

	log.Printf("üåê –ó–∞–ø—É—Å–∫–∞—é HTTP —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É %s", port)
	log.Println("======================================================")
	log.Println("ü§ñ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!")
	log.Println("üì® –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å—Å—è –≤ —á–∞—Ç:", forwardChatID)
	log.Println("======================================================")

	// –ó–∞–ø—É—Å–∫–∞–µ–º HTTP —Å–µ—Ä–≤–µ—Ä
	if err := http.ListenAndServe(":"+port, nil); err != nil {
		log.Fatalf("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä: %v", err)
	}
}

//======================================================
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
//======================================================

// getEnvOrDefault –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∑–Ω–∞—á–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
func getEnvOrDefault(key, defaultValue string) string {
	if value := os.Getenv(key); value != "" {
		return value
	}
	return defaultValue
}
